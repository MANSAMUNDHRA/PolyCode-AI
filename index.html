<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StackPilot</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
  --a: #a78bfa; --a2: #7c3aed;
  --bg: #080810; --s1: #0f0f1a; --s2: #14141f; --s3: #1a1a28;
  --bd: rgba(255,255,255,0.06); --bd2: rgba(255,255,255,0.1);
  --t1: #f0eeff; --t2: #9d9ab8; --t3: #5c5a72;
  --green: #4ade80; --red: #f87171; --yellow: #fbbf24;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Outfit',sans-serif; background:var(--bg); color:var(--t1); height:100vh; overflow:hidden; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH SCREENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#authScreen {
  display:flex; align-items:center; justify-content:center;
  height:100vh;
  background: radial-gradient(ellipse at 60% 20%, rgba(124,58,237,0.15) 0%, transparent 60%),
              radial-gradient(ellipse at 20% 80%, rgba(167,139,250,0.08) 0%, transparent 50%),
              var(--bg);
}

.auth-card {
  background: var(--s1);
  border: 1px solid var(--bd2);
  border-radius: 20px;
  padding: 40px;
  width: 100%;
  max-width: 420px;
  box-shadow: 0 24px 80px rgba(0,0,0,0.5);
}

.auth-logo {
  text-align: center;
  margin-bottom: 32px;
}

.auth-logo-icon {
  width: 52px; height: 52px;
  background: linear-gradient(135deg, var(--a), var(--a2));
  border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px;
  margin: 0 auto 14px;
}

.auth-logo h1 {
  font-size: 22px; font-weight: 700; letter-spacing: -0.3px;
}

.auth-logo p { font-size: 13px; color: var(--t3); margin-top: 4px; }

.auth-tabs {
  display: flex;
  background: var(--s2);
  border-radius: 10px;
  padding: 4px;
  margin-bottom: 28px;
}

.auth-tab {
  flex: 1; padding: 8px; border: none; background: transparent;
  color: var(--t3); font-family: 'Outfit',sans-serif;
  font-size: 14px; font-weight: 500; cursor: pointer;
  border-radius: 7px; transition: all 0.2s;
}

.auth-tab.active {
  background: var(--s3);
  color: var(--t1);
}

.auth-form { display: flex; flex-direction: column; gap: 14px; }

.field-label {
  font-size: 12px; font-weight: 600;
  color: var(--t3); text-transform: uppercase;
  letter-spacing: 0.06em; margin-bottom: 6px;
}

.field-wrap { position: relative; }

.field-wrap i {
  position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
  color: var(--t3); font-size: 13px;
}

.field-input {
  width: 100%;
  background: var(--s2);
  border: 1px solid var(--bd2);
  border-radius: 10px;
  padding: 12px 14px 12px 38px;
  color: var(--t1);
  font-family: 'Outfit',sans-serif;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.field-input::placeholder { color: var(--t3); }
.field-input:focus {
  border-color: rgba(167,139,250,0.5);
  box-shadow: 0 0 0 3px rgba(167,139,250,0.08);
}

.auth-btn {
  width: 100%;
  padding: 13px;
  background: linear-gradient(135deg, var(--a), var(--a2));
  border: none; border-radius: 10px;
  color: white; font-family: 'Outfit',sans-serif;
  font-size: 15px; font-weight: 600;
  cursor: pointer; margin-top: 6px;
  transition: opacity 0.2s, transform 0.15s;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}

.auth-btn:hover { opacity: 0.88; transform: translateY(-1px); }
.auth-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

.auth-error {
  background: rgba(248,113,113,0.1);
  border: 1px solid rgba(248,113,113,0.25);
  color: var(--red);
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 13px;
  display: none;
}

.auth-error.show { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#appScreen {
  display: none;
  height: 100vh;
  flex-direction: column;
}

#appScreen.visible { display: flex; }

.app-layout {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  width: 260px;
  background: var(--s1);
  border-right: 1px solid var(--bd);
  display: flex; flex-direction: column;
  flex-shrink: 0;
}

.brand {
  padding: 20px 18px 16px;
  border-bottom: 1px solid var(--bd);
  display: flex; align-items: center; gap: 10px;
}

.brand-icon {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, var(--a), var(--a2));
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; flex-shrink: 0;
}

.brand-name { font-size: 16px; font-weight: 700; letter-spacing: -0.3px; }

.new-chat-btn {
  margin: 12px 14px 8px;
  padding: 10px 14px;
  background: linear-gradient(135deg, var(--a), var(--a2));
  border: none; border-radius: 10px;
  color: white; font-family: 'Outfit',sans-serif;
  font-size: 13px; font-weight: 600;
  cursor: pointer;
  display: flex; align-items: center; gap: 8px;
  transition: opacity 0.2s, transform 0.15s;
}
.new-chat-btn:hover { opacity: 0.88; transform: translateY(-1px); }

.sb-section {
  padding: 8px 16px 4px;
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.1em; color: var(--t3);
}

/* language picker */
.lang-picker {
  display: flex; gap: 6px; padding: 6px 14px 10px;
}

.lang-pill {
  flex: 1; padding: 7px 6px;
  background: var(--s2); border: 1px solid var(--bd);
  border-radius: 8px; color: var(--t2);
  font-family: 'Outfit',sans-serif; font-size: 12px; font-weight: 600;
  cursor: pointer; text-align: center;
  transition: all 0.15s;
}
.lang-pill:hover { background: var(--s3); }
.lang-pill.on {
  background: rgba(167,139,250,0.12);
  border-color: rgba(167,139,250,0.3);
  color: var(--a);
}

/* history */
.history-scroll {
  flex: 1; overflow-y: auto; padding: 4px 10px;
}
.history-scroll::-webkit-scrollbar { width: 3px; }
.history-scroll::-webkit-scrollbar-thumb { background: var(--bd2); border-radius:3px; }

.hist-item {
  display: flex; align-items: center; gap: 8px;
  padding: 9px 10px;
  border-radius: 8px; cursor: pointer;
  transition: background 0.15s;
  border: 1px solid transparent;
}
.hist-item:hover { background: var(--s3); }
.hist-item.active {
  background: rgba(167,139,250,0.08);
  border-color: rgba(167,139,250,0.2);
}
.hist-item i { font-size: 10px; color: var(--t3); flex-shrink: 0; }
.hist-item-text { flex:1; font-size: 12px; color: var(--t2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.hist-item-del {
  opacity: 0; background: none; border: none; color: var(--t3);
  cursor: pointer; font-size: 11px; padding: 2px 4px;
  border-radius: 4px; transition: opacity 0.15s, color 0.15s;
}
.hist-item:hover .hist-item-del { opacity: 1; }
.hist-item-del:hover { color: var(--red); }

.hist-empty { font-size: 12px; color: var(--t3); padding: 12px 12px; text-align: center; }

/* user section */
.user-section {
  padding: 12px 14px;
  border-top: 1px solid var(--bd);
  display: flex; align-items: center; gap: 10px;
}
.user-avatar {
  width: 30px; height: 30px;
  background: linear-gradient(135deg, var(--a), var(--a2));
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; flex-shrink: 0;
}
.user-info { flex: 1; min-width: 0; }
.user-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-email { font-size: 11px; color: var(--t3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.logout-btn {
  background: none; border: none; color: var(--t3);
  cursor: pointer; font-size: 13px; padding: 4px;
  border-radius: 6px; transition: color 0.15s;
}
.logout-btn:hover { color: var(--red); }

/* â”€â”€ MAIN â”€â”€ */
.main { flex:1; display:flex; flex-direction:column; overflow:hidden; }

.topbar {
  height: 52px;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px;
  background: var(--s1); border-bottom: 1px solid var(--bd);
  flex-shrink: 0;
}

.topbar-left { display: flex; align-items: center; gap: 10px; }
.status-dot { width: 7px; height: 7px; background: var(--green); border-radius: 50%; animation: blink 2s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
.topbar-status { font-size: 13px; color: var(--t2); }
.model-badge {
  background: var(--s3); border: 1px solid var(--bd2);
  border-radius: 6px; padding: 4px 10px;
  font-size: 11px; font-family: 'JetBrains Mono',monospace; color: var(--t2);
}
.lang-badge {
  background: rgba(167,139,250,0.1); border: 1px solid rgba(167,139,250,0.25);
  border-radius: 6px; padding: 4px 10px;
  font-size: 11px; font-weight: 600; color: var(--a);
}

/* chat area */
.chat-area { flex:1; overflow-y:auto; padding: 28px 0; scroll-behavior: smooth; }
.chat-area::-webkit-scrollbar { width: 4px; }
.chat-area::-webkit-scrollbar-thumb { background: var(--bd2); border-radius:4px; }

.msgs {
  max-width: 820px; margin: 0 auto; padding: 0 28px;
  display: flex; flex-direction: column; gap: 24px;
}

.umsg {
  align-self: flex-end; max-width: 65%;
  background: var(--s3); border: 1px solid var(--bd2);
  border-radius: 18px 18px 4px 18px;
  padding: 13px 18px; font-size: 14px; line-height: 1.6;
  animation: fadeUp 0.2s ease;
}

.bmsg { align-self: flex-start; width: 100%; display: flex; gap: 12px; align-items: flex-start; animation: fadeUp 0.2s ease; }
.avatar {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, var(--a), var(--a2));
  border-radius: 8px; display: flex; align-items: center; justify-content: center;
  font-size: 13px; flex-shrink: 0; margin-top: 2px;
}
.bmsg-content { flex:1; min-width:0; }

/* code card */
.card { background: var(--s2); border: 1px solid var(--bd); border-radius: 14px; overflow: hidden; }

.card-top {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 16px; background: var(--s3); border-bottom: 1px solid var(--bd);
}
.card-dots { display: flex; gap: 6px; }
.card-dot { width: 10px; height: 10px; border-radius: 50%; }
.dot-r { background: #ff5f57; } .dot-y { background: #febc2e; } .dot-g { background: #28c840; }
.card-lang { font-size: 11px; font-weight: 700; letter-spacing: 0.08em; color: var(--a); text-transform: uppercase; font-family: 'JetBrains Mono',monospace; }
.card-btns { display: flex; gap: 6px; }
.cbtn {
  background: transparent; border: 1px solid var(--bd2); color: var(--t2);
  padding: 4px 10px; border-radius: 6px; font-size: 11px;
  font-family: 'Outfit',sans-serif; font-weight: 500; cursor: pointer;
  display: flex; align-items: center; gap: 5px; transition: all 0.15s;
}
.cbtn:hover { background: var(--bd); color: var(--t1); }
.cbtn.run:hover { background: rgba(74,222,128,0.1); border-color: rgba(74,222,128,0.3); color: var(--green); }

.code-pre { padding: 18px; overflow-x: auto; }
.code-pre pre { margin:0 !important; background: transparent !important; }
.code-pre code { font-family:'JetBrains Mono',monospace !important; font-size:13px !important; background:transparent !important; line-height:1.85; }

.edit-ta {
  display: none; width: 100%; background: transparent; color: var(--t1);
  border: none; outline: none; font-family:'JetBrains Mono',monospace;
  font-size: 13px; line-height: 1.85; resize: vertical; padding: 18px;
  min-height: 300px; height: auto;
}

.out-panel { border-top: 1px solid var(--bd); display: none; }
.out-panel.show { display: block; }
.out-header {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 16px; background: var(--s3); border-bottom: 1px solid var(--bd);
  font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--t3);
}
.out-body { padding: 14px 18px; font-size: 13px; font-family:'JetBrains Mono',monospace; line-height:1.7; color: var(--green); white-space: pre-wrap; }
.out-body.err { color: var(--red); }

/* thinking */
.thinking { display:flex; align-items:center; gap:8px; padding:16px 18px; color:var(--t3); font-size:13px; }
.dot-anim { display:flex; gap:4px; }
.dot-anim span { width:5px; height:5px; background:var(--a); border-radius:50%; animation:da 1.2s infinite; }
.dot-anim span:nth-child(2) { animation-delay:.2s; }
.dot-anim span:nth-child(3) { animation-delay:.4s; }
@keyframes da { 0%,80%,100%{transform:scale(0.7);opacity:0.4} 40%{transform:scale(1);opacity:1} }

/* empty */
.empty { max-width: 820px; margin: 0 auto; padding: 40px 28px; }
.empty-hero { text-align: center; margin-bottom: 36px; }
.empty-hero h2 { font-size: 24px; font-weight: 700; letter-spacing: -0.4px; margin-bottom: 8px; }
.empty-hero p { font-size: 14px; color: var(--t2); }
.eg-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.eg-card {
  background: var(--s2); border: 1px solid var(--bd);
  border-radius: 12px; padding: 16px; cursor: pointer;
  transition: border-color 0.2s, transform 0.15s, background 0.2s;
}
.eg-card:hover { border-color: rgba(167,139,250,0.35); background: var(--s3); transform: translateY(-2px); }
.eg-icon { font-size: 20px; margin-bottom: 8px; }
.eg-title { font-size: 13px; font-weight: 600; margin-bottom: 3px; }
.eg-desc { font-size: 12px; color: var(--t3); line-height: 1.4; }

/* input */
.input-zone { padding: 12px 24px 14px; background: var(--s1); border-top: 1px solid var(--bd); flex-shrink: 0; }
.input-wrap {
  max-width: 820px; margin: 0 auto;
  position: relative; background: var(--s2); border: 1px solid var(--bd2);
  border-radius: 14px; transition: border-color 0.2s, box-shadow 0.2s;
}
.input-wrap:focus-within { border-color: rgba(167,139,250,0.5); box-shadow: 0 0 0 3px rgba(167,139,250,0.08); }
.input-ta {
  width: 100%; background: transparent; border: none; outline: none;
  color: var(--t1); font-family: 'Outfit',sans-serif; font-size: 14px;
  padding: 14px 56px 14px 18px; resize: none; max-height: 160px; line-height: 1.6;
}
.input-ta::placeholder { color: var(--t3); }
.send-btn {
  position: absolute; right: 10px; bottom: 10px;
  width: 36px; height: 36px;
  background: linear-gradient(135deg, var(--a), var(--a2));
  border: none; border-radius: 9px; color: white; font-size: 14px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: opacity 0.2s, transform 0.15s;
}
.send-btn:hover { opacity: 0.85; transform: scale(1.05); }
.send-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
.input-hint { max-width: 820px; margin: 7px auto 0; font-size: 11px; color: var(--t3); }

/* theme swatches */
.swatch-row { display: flex; gap: 7px; padding: 4px 14px 12px; }
.sw { width: 18px; height: 18px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s, border-color 0.2s; }
.sw:hover { transform: scale(1.2); }
.sw.on { border-color: white; }
.sw-v{background:#a78bfa} .sw-b{background:#60a5fa} .sw-g{background:#34d399}
.sw-r{background:#f87171} .sw-o{background:#fb923c} .sw-p{background:#f472b6}

/* toast */
.toast {
  position: fixed; bottom: 80px; left: 50%;
  transform: translateX(-50%) translateY(10px);
  background: var(--s3); border: 1px solid var(--bd2); color: var(--t1);
  padding: 9px 18px; border-radius: 8px; font-size: 13px;
  opacity: 0; transition: all 0.2s; pointer-events: none; z-index: 99;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
* { scrollbar-width: thin; scrollbar-color: var(--bd2) transparent; }
@media(max-width:680px) { .sidebar{display:none} .eg-grid{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â• AUTH SCREEN â•â•â•â•â•â•â•â• -->
<div id="authScreen">
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-icon">ğŸ’»</div>
      <h1>StackPilot</h1>
      <p>AI-powered code generation assistant</p>
    </div>

    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchTab('login')">Sign In</button>
      <button class="auth-tab" onclick="switchTab('signup')">Create Account</button>
    </div>

    <div id="authError" class="auth-error"></div>

    <!-- LOGIN FORM -->
    <form class="auth-form" id="loginForm" onsubmit="doLogin(event)">
      <div>
        <div class="field-label">Email</div>
        <div class="field-wrap">
          <i class="fas fa-envelope"></i>
          <input class="field-input" type="email" id="loginEmail" placeholder="you@example.com" required>
        </div>
      </div>
      <div>
        <div class="field-label">Password</div>
        <div class="field-wrap">
          <i class="fas fa-lock"></i>
          <input class="field-input" type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
        </div>
      </div>
      <button type="submit" class="auth-btn" id="loginBtn">
        <i class="fas fa-arrow-right"></i> Sign In
      </button>
    </form>

    <!-- SIGNUP FORM -->
    <form class="auth-form" id="signupForm" style="display:none" onsubmit="doSignup(event)">
      <div>
        <div class="field-label">Name</div>
        <div class="field-wrap">
          <i class="fas fa-user"></i>
          <input class="field-input" type="text" id="signupName" placeholder="Your name" required>
        </div>
      </div>
      <div>
        <div class="field-label">Email</div>
        <div class="field-wrap">
          <i class="fas fa-envelope"></i>
          <input class="field-input" type="email" id="signupEmail" placeholder="you@example.com" required>
        </div>
      </div>
      <div>
        <div class="field-label">Password</div>
        <div class="field-wrap">
          <i class="fas fa-lock"></i>
          <input class="field-input" type="password" id="signupPassword" placeholder="Min. 6 characters" required>
        </div>
      </div>
      <button type="submit" class="auth-btn" id="signupBtn">
        <i class="fas fa-user-plus"></i> Create Account
      </button>
    </form>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• APP SCREEN â•â•â•â•â•â•â•â• -->
<div id="appScreen">
  <div class="app-layout">

    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="brand">
        <div class="brand-icon">ğŸ’»</div>
        <div class="brand-name">StackPilot</div>
      </div>

      <button class="new-chat-btn" onclick="newChat()">
        <i class="fas fa-plus"></i> New Chat
      </button>

      <div class="sb-section">Language</div>
      <div class="lang-picker">
        <div class="lang-pill on" id="lp-python" onclick="setLang('python')">Python</div>
        <div class="lang-pill" id="lp-javascript" onclick="setLang('javascript')">JS</div>
      </div>

      <div class="sb-section" style="margin-top:4px">History</div>
      <div class="history-scroll" id="historyList">
        <div class="hist-empty">No chats yet</div>
      </div>

      <div class="sb-section">Accent</div>
      <div class="swatch-row">
        <div class="sw sw-v on" onclick="setAccent('#a78bfa','#7c3aed',this)"></div>
        <div class="sw sw-b" onclick="setAccent('#60a5fa','#2563eb',this)"></div>
        <div class="sw sw-g" onclick="setAccent('#34d399','#059669',this)"></div>
        <div class="sw sw-r" onclick="setAccent('#f87171','#dc2626',this)"></div>
        <div class="sw sw-o" onclick="setAccent('#fb923c','#ea580c',this)"></div>
        <div class="sw sw-p" onclick="setAccent('#f472b6','#db2777',this)"></div>
      </div>

      <div class="user-section">
        <div class="user-avatar" id="userAvatar">?</div>
        <div class="user-info">
          <div class="user-name" id="userName">â€”</div>
          <div class="user-email" id="userEmail">â€”</div>
        </div>
        <button class="logout-btn" onclick="doLogout()" title="Sign out">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <div class="topbar">
        <div class="topbar-left">
          <div class="status-dot" id="statusDot"></div>
          <span class="topbar-status" id="topbarStatus">Ready</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="lang-badge" id="langBadge">Python</div>
          <div class="model-badge">Qwen2.5-72B</div>
        </div>
      </div>

      <div class="chat-area" id="chatArea">
        <!-- EMPTY STATE -->
        <div class="empty" id="emptyState">
          <div class="empty-hero">
            <h2 id="greetingTitle"></h2>
            <p id="greetingSub"></p>
          </div>
          <div class="eg-grid">
            <div class="eg-card" onclick="go('sum two numbers')"><div class="eg-icon">â•</div><div class="eg-title">Sum two numbers</div><div class="eg-desc">Add two values and print result</div></div>
            <div class="eg-card" onclick="go('fibonacci sequence up to 10 terms')"><div class="eg-icon">ğŸŒ€</div><div class="eg-title">Fibonacci</div><div class="eg-desc">First 10 Fibonacci numbers</div></div>
            <div class="eg-card" onclick="go('check if a number is prime')"><div class="eg-icon">ğŸ”¢</div><div class="eg-title">Prime checker</div><div class="eg-desc">Test if a number is prime</div></div>
            <div class="eg-card" onclick="go('bubble sort a list of numbers')"><div class="eg-icon">ğŸ«§</div><div class="eg-title">Bubble sort</div><div class="eg-desc">Sort a list using bubble sort</div></div>
            <div class="eg-card" onclick="go('factorial of a number using a loop')"><div class="eg-icon">ğŸ“</div><div class="eg-title">Factorial</div><div class="eg-desc">Calculate factorial with a loop</div></div>
            <div class="eg-card" onclick="go('reverse a string')"><div class="eg-icon">ğŸ”„</div><div class="eg-title">Reverse string</div><div class="eg-desc">Reverse any string input</div></div>
          </div>
        </div>
        <div class="msgs" id="msgs" style="display:none"></div>
      </div>

      <div class="input-zone">
        <div class="input-wrap">
          <textarea class="input-ta" id="inputTa" placeholder="Describe what you want to code..." rows="1"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMsg()">
            <i class="fas fa-arrow-up"></i>
          </button>
        </div>
        <div class="input-hint">Enter to send Â· Shift+Enter for new line</div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-python.min.js"></script>
<script>
const API = 'http://localhost:9000';
let token = localStorage.getItem('token');
let currentUser = null;
let currentLang = 'python';
let currentChatId = null;
let busy = false;
let cardN = 0;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function boot() {
  if (!token) return showAuth();
  try {
    const r = await apiFetch('/auth/me');
    if (!r.ok) throw new Error();
    const { user } = await r.json();
    loginSuccess(user);
  } catch {
    localStorage.removeItem('token');
    token = null;
    showAuth();
  }
}

function showAuth() {
  document.getElementById('authScreen').style.display = 'flex';
  document.getElementById('appScreen').classList.remove('visible');
}

function loginSuccess(user) {
  currentUser = user;
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('appScreen').classList.add('visible');
  document.getElementById('userName').textContent = user.name;
  document.getElementById('userEmail').textContent = user.email;
  document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
  setGreeting();
  loadHistory();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function apiFetch(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  return fetch(API + path, { ...opts, headers });
}

function switchTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (tab==='login'&&i===0)||(tab==='signup'&&i===1)));
  document.getElementById('loginForm').style.display  = tab === 'login'  ? 'flex' : 'none';
  document.getElementById('signupForm').style.display = tab === 'signup' ? 'flex' : 'none';
  document.getElementById('authError').classList.remove('show');
}

function showAuthError(msg) {
  const el = document.getElementById('authError');
  el.textContent = msg;
  el.classList.add('show');
}

async function doLogin(e) {
  e.preventDefault();
  const btn = document.getElementById('loginBtn');
  btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
  try {
    const r = await fetch(API + '/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email:    document.getElementById('loginEmail').value,
        password: document.getElementById('loginPassword').value
      })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error);
    token = d.token;
    localStorage.setItem('token', token);
    loginSuccess(d.user);
  } catch (err) {
    showAuthError(err.message);
  } finally {
    btn.disabled = false; btn.innerHTML = '<i class="fas fa-arrow-right"></i> Sign In';
  }
}

async function doSignup(e) {
  e.preventDefault();
  const btn = document.getElementById('signupBtn');
  btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
  try {
    const r = await fetch(API + '/auth/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name:     document.getElementById('signupName').value,
        email:    document.getElementById('signupEmail').value,
        password: document.getElementById('signupPassword').value
      })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error);
    token = d.token;
    localStorage.setItem('token', token);
    loginSuccess(d.user);
  } catch (err) {
    showAuthError(err.message);
  } finally {
    btn.disabled = false; btn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
  }
}

function doLogout() {
  token = null; currentUser = null; currentChatId = null;
  localStorage.removeItem('token');
  document.getElementById('msgs').innerHTML = '';
  document.getElementById('historyList').innerHTML = '<div class="hist-empty">No chats yet</div>';
  showAuth();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadHistory() {
  try {
    const r = await apiFetch('/history');
    const { chats } = await r.json();
    renderHistory(chats);
  } catch {}
}

function renderHistory(chats) {
  const list = document.getElementById('historyList');
  if (!chats || !chats.length) {
    list.innerHTML = '<div class="hist-empty">No chats yet</div>';
    return;
  }
  list.innerHTML = chats.map(c => `
    <div class="hist-item ${c._id === currentChatId ? 'active' : ''}" id="hi-${c._id}" onclick="loadChat('${c._id}')">
      <i class="fas fa-code"></i>
      <div class="hist-item-text">${esc(c.title)}</div>
      <button class="hist-item-del" onclick="deleteChat(event,'${c._id}')" title="Delete">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `).join('');
}

async function loadChat(id) {
  try {
    const r = await apiFetch('/history/' + id);
    const { chat } = await r.json();
    currentChatId = id;
    currentLang = chat.language || 'python';
    updateLangUI();

    // Show chat
    document.getElementById('emptyState').style.display = 'none';
    const msgsEl = document.getElementById('msgs');
    msgsEl.style.display = 'flex';
    msgsEl.innerHTML = '';

    chat.messages.forEach(m => {
      if (m.role === 'user') {
        const d = document.createElement('div');
        d.className = 'umsg';
        d.textContent = m.content;
        msgsEl.appendChild(d);
      } else if (m.role === 'assistant' && m.code) {
        const d = document.createElement('div');
        d.className = 'bmsg';
        d.innerHTML = `<div class="avatar">AI</div><div class="bmsg-content">${makeCard(m.code, m.language)}</div>`;
        msgsEl.appendChild(d);
        const codeEl = d.querySelector('code');
        if (codeEl) Prism.highlightElement(codeEl);
      }
    });

    // Update active state
    document.querySelectorAll('.hist-item').forEach(el => el.classList.remove('active'));
    const el = document.getElementById('hi-' + id);
    if (el) el.classList.add('active');

    scrollBot();
  } catch (err) {
    toast('Failed to load chat');
  }
}

async function deleteChat(e, id) {
  e.stopPropagation();
  await apiFetch('/history/' + id, { method: 'DELETE' });
  if (currentChatId === id) newChat();
  await loadHistory();
  toast('Chat deleted');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANGUAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setLang(lang) {
  currentLang = lang;
  updateLangUI();
}

function updateLangUI() {
  ['python','javascript'].forEach(l => {
    document.getElementById('lp-' + l)?.classList.toggle('on', l === currentLang);
  });
  document.getElementById('langBadge').textContent = currentLang === 'javascript' ? 'JavaScript' : 'Python';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setAccent(c1, c2, el) {
  document.documentElement.style.setProperty('--a', c1);
  document.documentElement.style.setProperty('--a2', c2);
  document.querySelectorAll('.sw').forEach(s => s.classList.remove('on'));
  el.classList.add('on');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ta = document.getElementById('inputTa');
ta.addEventListener('input', () => {
  ta.style.height = 'auto';
  ta.style.height = Math.min(ta.scrollHeight, 160) + 'px';
});
ta.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
});

function go(text) { ta.value = text; ta.dispatchEvent(new Event('input')); sendMsg(); }
function newChat() {
  currentChatId = null;
  setGreeting();
  document.getElementById('emptyState').style.display = '';
  const msgsEl = document.getElementById('msgs');
  msgsEl.style.display = 'none';
  msgsEl.innerHTML = '';
  document.querySelectorAll('.hist-item').forEach(el => el.classList.remove('active'));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}
function scrollBot() {
  const ca = document.getElementById('chatArea');
  ca.scrollTo({ top: ca.scrollHeight, behavior: 'smooth' });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CODE CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function makeCard(code, lang) {
  const id = 'c' + (++cardN);
  const langLabel = lang === 'javascript' ? 'JavaScript' : lang === 'python' ? 'Python' : lang || 'Code';
  return `
  <div class="card" id="${id}">
    <div class="card-top">
      <div class="card-dots"><div class="card-dot dot-r"></div><div class="card-dot dot-y"></div><div class="card-dot dot-g"></div></div>
      <span class="card-lang">${langLabel}</span>
      <div class="card-btns">
        <button type="button" class="cbtn" onclick="editCard('${id}')"><i class="fas fa-pen"></i> Edit</button>
        <button type="button" class="cbtn" onclick="copyCard('${id}')"><i class="fas fa-copy"></i> Copy</button>
        <button type="button" class="cbtn run" data-cardid="${id}" id="${id}-runbtn"><i class="fas fa-play"></i> Run</button>
      </div>
    </div>
    <div class="code-pre" id="${id}-pre"><pre><code class="language-python" id="${id}-code">${esc(code)}</code></pre></div>
    <textarea class="edit-ta" id="${id}-ta">${code}</textarea>
    <div class="out-panel" id="${id}-out">
      <div class="out-header"><i class="fas fa-terminal"></i>&nbsp; Output</div>
      <div class="out-body" id="${id}-res"></div>
    </div>
  </div>`;
}

function updateCard(id, code) {
  const codeEl = document.getElementById(id + '-code');
  const taEl   = document.getElementById(id + '-ta');
  if (codeEl) { codeEl.textContent = code; Prism.highlightElement(codeEl); }
  if (taEl)   taEl.value = code;
}

function editCard(id) {
  const pre = document.getElementById(id + '-pre');
  const ta  = document.getElementById(id + '-ta');
  const btn = document.querySelector(`[onclick="editCard('${id}')"]`);

  if (ta.style.display === 'block') {
    // Save mode â†’ apply edits, switch back to highlighted view
    document.getElementById(id + '-code').textContent = ta.value;
    Prism.highlightElement(document.getElementById(id + '-code'));
    pre.style.display = '';
    ta.style.display = 'none';
    if (btn) { btn.innerHTML = '<i class="fas fa-pen"></i> Edit'; }
  } else {
    // Edit mode â†’ show textarea, auto-size to content
    pre.style.display = 'none';
    ta.style.display = 'block';
    ta.style.height = 'auto';
    ta.style.height = Math.max(300, ta.scrollHeight) + 'px';
    ta.focus();
    // Move cursor to end
    ta.selectionStart = ta.selectionEnd = ta.value.length;
    if (btn) { btn.innerHTML = '<i class="fas fa-check"></i> Save'; }
    // Auto-grow as user types
    ta.oninput = () => {
      ta.style.height = 'auto';
      ta.style.height = Math.max(300, ta.scrollHeight) + 'px';
    };
  }
}

function copyCard(id) {
  navigator.clipboard.writeText(document.getElementById(id + '-ta').value)
    .then(() => toast('Copied!'));
}

// Run button â€” uses event delegation on document so dynamic cards always work
document.addEventListener('click', async function(e) {
  const btn = e.target.closest('.cbtn.run');
  if (!btn) return;

  e.preventDefault();
  e.stopPropagation();

  const id  = btn.dataset.cardid;
  if (!id) return;

  const code = document.getElementById(id + '-ta').value;
  const out  = document.getElementById(id + '-out');
  const res  = document.getElementById(id + '-res');

  // Spinner â€” use textContent trick to avoid re-parsing HTML
  btn.setAttribute('disabled', 'true');
  btn.textContent = 'â–º Running...';

  out.classList.add('show');
  res.className = 'out-body';
  res.textContent = 'Runningâ€¦';

  try {
    const r = await apiFetch('/run', {
      method: 'POST',
      body: JSON.stringify({ code, language: currentLang })
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error);
    res.textContent = d.output || '(no output)';
  } catch(err) {
    res.classList.add('err');
    res.textContent = err.message;
  }

  // Restore button â€” do NOT use innerHTML, just textContent
  btn.removeAttribute('disabled');
  btn.textContent = 'â–º Run';
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEND MESSAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sendMsg() {
  if (busy) return;
  const msg = ta.value.trim();
  if (!msg) return;

  document.getElementById('emptyState').style.display = 'none';
  const msgsEl = document.getElementById('msgs');
  msgsEl.style.display = 'flex';

  // user bubble
  const uDiv = document.createElement('div');
  uDiv.className = 'umsg';
  uDiv.textContent = msg;
  msgsEl.appendChild(uDiv);

  ta.value = ''; ta.style.height = 'auto';
  scrollBot();

  // bot row
  const bRow = document.createElement('div');
  bRow.className = 'bmsg';
  bRow.innerHTML = `<div class="avatar">AI</div><div class="bmsg-content"><div class="card"><div class="thinking"><div class="dot-anim"><span></span><span></span><span></span></div>Generatingâ€¦</div></div></div>`;
  msgsEl.appendChild(bRow);
  scrollBot();

  busy = true;
  document.getElementById('sendBtn').disabled = true;
  document.getElementById('topbarStatus').textContent = 'Generatingâ€¦';

  try {
    const r = await apiFetch('/chat', {
      method: 'POST',
      body: JSON.stringify({ message: msg, language: currentLang, chatId: currentChatId })
    });

    if (!r.ok) { const d = await r.json(); throw new Error(d.error); }

    const reader = r.body.getReader();
    const dec = new TextDecoder();
    let full = '', cardId = null;
    const content = bRow.querySelector('.bmsg-content');

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      const lines = dec.decode(value).split('\n');
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const d = line.slice(6);
        if (d === '[DONE]') break;
        try {
          const p = JSON.parse(d);
          // chatId from first chunk
          if (p.chatId && !currentChatId) {
            currentChatId = p.chatId;
            await loadHistory();
          }
          if (!p.content) continue;
          full += p.content;
          const clean = full.replace(/^```[\w]*\n?/, '').replace(/\n?```$/, '').trim();
          if (!cardId) {
            content.innerHTML = makeCard(clean, currentLang);
            cardId = content.querySelector('.card').id;
            Prism.highlightElement(document.getElementById(cardId + '-code'));
          } else {
            updateCard(cardId, clean);
          }
          scrollBot();
        } catch {}
      }
    }

  } catch (err) {
    bRow.querySelector('.bmsg-content').innerHTML =
      `<div style="color:var(--red);font-size:13px;padding:4px 0">${err.message}</div>`;
  } finally {
    busy = false;
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('topbarStatus').textContent = 'Ready';
    scrollBot();
  }
}

function setGreeting() {
  const hour = new Date().getHours();
  const name = currentUser?.name?.split(' ')[0] || 'Developer';
  const pick = arr => arr[Math.floor(Math.random() * arr.length)];

  const slots = [
    {
      // 5am - 12pm
      test: h => h >= 5 && h < 12,
      titles: [
        `Good morning, ${name}. â˜•`,
        `Rise and grind, ${name}. â˜€ï¸`,
        `Oh look, ${name} is awake. ğŸ‘€`,
        `Morning, ${name}. Coffee first, bugs second. â˜•`,
        `Up early, ${name}? Respect. ğŸ«¡`,
      ],
      subs: [
        "Let's ship something before the world wakes up.",
        "The best code gets written before 9am. Probably.",
        "Today's a good day to close 12 tabs and open 40 new ones.",
        "Your terminal is already judging you. Be faster.",
        "Somewhere a bug is waiting. Go find it first.",
      ]
    },
    {
      // 12pm - 5pm
      test: h => h >= 12 && h < 17,
      titles: [
        `Good afternoon, ${name}.`,
        `Afternoon, ${name}. Still alive? ğŸ’ª`,
        `Hey ${name}, post-lunch slump? Code through it.`,
        `Afternoon check-in, ${name}. ğŸŒ¤ï¸`,
        `${name}, the afternoon shift has begun.`,
      ],
      subs: [
        "Still productive? That's honestly impressive.",
        "The commit history doesn't lie. Let's make it look good.",
        "Halfway through the day. Let's make the second half count.",
        "Your code from this morning called. It wants refactoring.",
        "An afternoon build a day keeps the tech debt away. (It doesn't.)",
      ]
    },
    {
      // 5pm - 11pm
      test: h => h >= 17 && h < 23,
      titles: [
        `Good evening, ${name}. ğŸŒ™`,
        `Evening, ${name}. One more feature? ğŸ‘€`,
        `Still here, ${name}? Respect. ğŸŒ†`,
        `Night mode: ON. ${name} mode: also ON. ğŸŒ™`,
        `Evening vibes, ${name}. ğŸ§`,
      ],
      subs: [
        "Time to pretend we're not tired and ship something.",
        "Dead tired but still coding? ",
        "The best ideas come after 12. Science says so. (It doesn't.)",
        "One more feature and then sleep. (We both know that's a lie.)",
        "Your future self will thank you for this commit. Maybe.",
      ]
    },
    {
      // 11pm - 5am
      test: () => true,
      titles: [
        `It's way too late, ${name}. ğŸŒ‘`,
        `${name}... go to sleep. ğŸ˜­`,
        `3AM coder spotted. ğŸ‘¾`,
        `Why are you like this, ${name}? ğŸ¥²`,
        `Bro. ${name}. It's late. ğŸ’€`,
      ],
      subs: [
        "Caffeine detected. Sleep not found.",
        "The bugs you create at 3am are special. Not in a good way.",
        "Sleep is a performance optimization. Just saying.",
        "Your git commit message at this hour will haunt you.",
        "Somewhere a rubber duck is very concerned about you.",
      ]
    }
  ];

  const slot = slots.find(s => s.test(hour));
  const t = document.getElementById('greetingTitle');
  const s = document.getElementById('greetingSub');
  if (t) t.textContent = pick(slot.titles);
  if (s) s.textContent = pick(slot.subs);
}

boot();
</script>
</body>
</html>